<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.resto.shop.web.dao.ArticleRecommendMapper">


    <resultMap id="RecommendResultMap" type="com.resto.shop.web.model.ArticleRecommend">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="is_used" property="isUsed"/>
        <result column="count" property="count"/>
        <collection property="articles" javaType="List" ofType="com.resto.shop.web.model.ArticleRecommendPrice">
            <id column="article_recommend_price_id" property="id"/>
            <result column="article_id" property="articleId"/>
            <result column="article_name" property="articleName"/>
            <result column="price" property="price"/>
            <result column="max_count" property="maxCount"/>
            <result column="sort" property="sort"/>
        </collection>
    </resultMap>

    <select id="getRecommendList" resultMap="RecommendResultMap">
        select t.id,t.name,t.count,t.is_used,t.sort,t2.id as article_recommend_price_id,t2.article_id,t2.article_name
        ,t2.price,t2.max_count,t2.sort as count from tb_recommend t
        left join tb_recommend_article t2 on t2.recommend_id = t.id
         where t.shop_detail_id = #{shopId}
        and t.is_used = 0
        order by t.create_time desc
    </select>

    <insert id="insertSelective" parameterType="ArticleRecommend" >
       insert into tb_recommend
       (id,count,name,shop_detail_id)
       values(#{id},#{count},#{name},#{shopId})
    </insert>

    <insert id="insertRecommendArticle">

        insert into tb_recommend_article
        (recommend_id,article_id,max_count,price,article_name,sort)
        VALUES
        (#{recommendId}
        ,#{articleRecommendPrice.articleId},#{articleRecommendPrice.maxCount},#{articleRecommendPrice.price}
        ,#{articleRecommendPrice.articleName},#{articleRecommendPrice.sort}

        )
    </insert>


    <update id="updateByPrimaryKeySelective">
        update tb_recommend
        <set>
            <if test="name != null">
                name = #{name},
            </if>
            <if test="count != null">
                count = #{count}
            </if>

        </set>
        where id = #{id}

    </update>

    <select id="getRecommendById" resultMap="RecommendResultMap">
        select t.id,t.name,t.count,t.is_used,
        t2.id as article_recommend_price_id,t2.article_id,t2.max_count,t2.price,t2.article_name,
        t2.sort
        from tb_recommend t
        left join tb_recommend_article t2 on t2.recommend_id = t.id
        where t.id = #{id}

    </select>

    <delete id="deleteByPrimaryKey" parameterType="java.lang.String">delete from tb_recommend where id = #{id,jdbcType=VARCHAR}</delete>


    <delete id="deleteRecommendArticle">
        delete from tb_recommend_article
        where recommend_id = #{recommendId}
    </delete>

    <select id="getRecommendByArticleId" resultMap="RecommendResultMap">
        select t3.article_name,t3.price,t3.article_id,t3.max_count,t2.count from tb_article t
      INNER JOIN tb_recommend t2 on t2.id = t.recommend_id
      INNER JOIN tb_recommend_article t3 on t3.recommend_id = t2.id
where t2.shop_detail_id = #{shopId} and t.id = #{articleId}

    </select>

    <delete id="deleteRecommendByArticleId">
        delete from tb_recommend_article where article_id = #{id}
    </delete>
</mapper>