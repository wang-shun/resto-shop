<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.resto.shop.web.dao.ChargeOrderMapper">
  <resultMap id="BaseResultMap" type="com.resto.shop.web.model.ChargeOrder" >
    <id column="id" property="id" jdbcType="VARCHAR" />
    <result column="charge_money" property="chargeMoney" jdbcType="DECIMAL" />
    <result column="reward_money" property="rewardMoney" jdbcType="DECIMAL" />
    <result column="order_state" property="orderState" jdbcType="TINYINT" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="finish_time" property="finishTime" jdbcType="TIMESTAMP" />
    <result column="customer_id" property="customerId" jdbcType="VARCHAR" />
    <result column="brand_id" property="brandId" jdbcType="VARCHAR" />
    <result column="shop_detail_id" property="shopDetailId" jdbcType="VARCHAR" />
    <result column="charge_balance" property="chargeBalance" jdbcType="DECIMAL" />
    <result column="reward_balance" property="rewardBalance" jdbcType="DECIMAL" />
    <result column="total_balance" property="totalBalance" jdbcType="DECIMAL" />
    <result column="number_day_now" property="numberDayNow"/>
    <result column="arrival_amount" property="arrivalAmount"/>
    <result column="end_amount" property="endAmount"/>
    <result column="type" property="type"/>
  </resultMap>

  <!--店铺详细-->
  <resultMap id="ShopchargecordMap" type="com.resto.shop.web.model.ChargeOrder">
    <id column="id" property="id" jdbcType="VARCHAR" />
    <result column="charge_money" property="chargeMoney" jdbcType="DECIMAL" />
    <result column="reward_money" property="rewardMoney" jdbcType="DECIMAL" />
    <result column="finish_time" property="finishTime" jdbcType="TIMESTAMP" />
    <result column="shop_detail_id" property="shopDetailId" jdbcType="VARCHAR" />
    <result column="type" property="type"/>
    <!--充值详细-->
    <association property="chargelog" javaType="com.resto.shop.web.model.ChargeLog">
      <id column="cid" property="id" jdbcType="VARCHAR" />
      <result column="operation_phone" property="operationPhone" jdbcType="VARCHAR" />
      <result column="customer_phone"  property="customerPhone" jdbcType="VARCHAR" />
    </association>
  </resultMap>


  <sql id="Base_Column_List" >
    id, charge_money, reward_money, order_state, create_time, finish_time, customer_id,
    brand_id, shop_detail_id, charge_balance, reward_balance, total_balance, number_day_now, arrival_amount, end_amount, type
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select
    <include refid="Base_Column_List" />
    from tb_charge_order
    where id = #{id,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    delete from tb_charge_order
    where id = #{id,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.resto.shop.web.model.ChargeOrder" >
    insert into tb_charge_order (id, charge_money, reward_money, order_state, create_time, finish_time, customer_id, brand_id, shop_detail_id,
    charge_balance, reward_balance, total_balance, number_day_now, arrival_amount, end_amount, type
    )
    values (#{id,jdbcType=VARCHAR}, #{chargeMoney,jdbcType=DECIMAL}, #{rewardMoney,jdbcType=DECIMAL},
      #{orderState,jdbcType=TINYINT}, #{createTime,jdbcType=TIMESTAMP}, #{finishTime,jdbcType=TIMESTAMP},
      #{customerId,jdbcType=VARCHAR}, #{brandId,jdbcType=VARCHAR}, #{shopDetailId,jdbcType=VARCHAR},
      #{chargeBalance,jdbcType=DECIMAL}, #{rewardBalance,jdbcType=DECIMAL}, #{totalBalance,jdbcType=DECIMAL},
      #{numberDayNow}, #{arrivalAmount}, #{endAmount}, #{type}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.resto.shop.web.model.ChargeOrder" >
    insert into tb_charge_order
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="chargeMoney != null" >
        charge_money,
      </if>
      <if test="rewardMoney != null" >
        reward_money,
      </if>
      <if test="orderState != null" >
        order_state,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="finishTime != null" >
        finish_time,
      </if>
      <if test="customerId != null" >
        customer_id,
      </if>
      <if test="brandId != null" >
        brand_id,
      </if>
      <if test="shopDetailId != null" >
        shop_detail_id,
      </if>
      <if test="chargeBalance != null" >
        charge_balance,
      </if>
      <if test="rewardBalance != null" >
        reward_balance,
      </if>
      <if test="totalBalance != null" >
        total_balance,
      </if>
      <if test="numberDayNow != null" >
        number_day_now,
      </if>
      <if test="arrivalAmount != null" >
        arrival_amount,
      </if>
      <if test="endAmount != null" >
        end_amount,
      </if>
      <if test="type != null" >
        `type`,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="chargeMoney != null" >
        #{chargeMoney,jdbcType=DECIMAL},
      </if>
      <if test="rewardMoney != null" >
        #{rewardMoney,jdbcType=DECIMAL},
      </if>
      <if test="orderState != null" >
        #{orderState,jdbcType=TINYINT},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="finishTime != null" >
        #{finishTime,jdbcType=TIMESTAMP},
      </if>
      <if test="customerId != null" >
        #{customerId,jdbcType=VARCHAR},
      </if>
      <if test="brandId != null" >
        #{brandId,jdbcType=VARCHAR},
      </if>
      <if test="shopDetailId != null" >
        #{shopDetailId,jdbcType=VARCHAR},
      </if>
      <if test="chargeBalance != null" >
        #{chargeBalance,jdbcType=DECIMAL},
      </if>
      <if test="rewardBalance != null" >
        #{rewardBalance,jdbcType=DECIMAL},
      </if>
      <if test="totalBalance != null" >
        #{totalBalance,jdbcType=DECIMAL},
      </if>
      <if test="numberDayNow != null" >
        #{numberDayNow},
      </if>
      <if test="arrivalAmount != null" >
        #{arrivalAmount},
      </if>
      <if test="endAmount != null" >
        #{endAmount},
      </if>
      <if test="type != null" >
        #{type},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.resto.shop.web.model.ChargeOrder" >
    update tb_charge_order
    <set >
      <if test="chargeMoney != null" >
        charge_money = #{chargeMoney,jdbcType=DECIMAL},
      </if>
      <if test="rewardMoney != null" >
        reward_money = #{rewardMoney,jdbcType=DECIMAL},
      </if>
      <if test="orderState != null" >
        order_state = #{orderState,jdbcType=TINYINT},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="finishTime != null" >
        finish_time = #{finishTime,jdbcType=TIMESTAMP},
      </if>
      <if test="customerId != null" >
        customer_id = #{customerId,jdbcType=VARCHAR},
      </if>
      <if test="brandId != null" >
        brand_id = #{brandId,jdbcType=VARCHAR},
      </if>
      <if test="shopDetailId != null" >
        shop_detail_id = #{shopDetailId,jdbcType=VARCHAR},
      </if>
      <if test="chargeBalance != null" >
        charge_balance = #{chargeBalance,jdbcType=DECIMAL},
      </if>
      <if test="rewardBalance != null" >
        reward_balance = #{rewardBalance,jdbcType=DECIMAL},
      </if>
      <if test="totalBalance != null" >
        total_balance = #{totalBalance,jdbcType=DECIMAL},
      </if>
      <if test="numberDayNow != null" >
        number_day_now = #{numberDayNow},
      </if>
      <if test="arrivalAmount != null" >
        arrival_amount = #{arrivalAmount},
      </if>
      <if test="endAmount != null" >
        end_amount = #{endAmount},
      </if>
      <if test="type != null" >
        `type` = #{type},
      </if>
    </set>
    where id = #{id,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.resto.shop.web.model.ChargeOrder" >
    update tb_charge_order
    set charge_money = #{chargeMoney,jdbcType=DECIMAL},
      reward_money = #{rewardMoney,jdbcType=DECIMAL},
      order_state = #{orderState,jdbcType=TINYINT},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      finish_time = #{finishTime,jdbcType=TIMESTAMP},
      customer_id = #{customerId,jdbcType=VARCHAR},
      brand_id = #{brandId,jdbcType=VARCHAR},
      shop_detail_id = #{shopDetailId,jdbcType=VARCHAR},
      charge_balance = #{chargeBalance,jdbcType=DECIMAL},
      reward_balance = #{rewardBalance,jdbcType=DECIMAL},
      total_balance = #{totalBalance,jdbcType=DECIMAL},
      number_day_now = #{numberDayNow},
      arrival_amount = #{arrivalAmount},
      end_amount = #{endAmount},`type` = #{type}
    where id = #{id,jdbcType=VARCHAR}
  </update>
  <select id="selectList" resultType="ChargeOrder">select * from tb_charge_order</select>
  <select id="selectTotalBalance" resultType="DECIMAL">
  	SELECT SUM(total_balance) FROM tb_charge_order
	WHERE order_state=1
	AND total_balance>0
	AND customer_id=#{0}
  </select>
  <select id="selectFirstBalanceOrder" resultType="ChargeOrder">
  	SELECT * FROM tb_charge_order
	WHERE order_state=1
	AND total_balance>0
	AND customer_id=#{0}
	ORDER BY finish_time
	LIMIT 0,1
  </select>
  <!--店铺充值详细-->
  <select id="shopChargeCodes" resultMap="ShopchargecordMap" >
    SELECT  o.id ,o.charge_money ,o.reward_money, o.finish_time,o.shop_detail_id ,o.type,c.id  cid,c.operation_phone,c.customer_phone  from tb_charge_order o
    LEFT  JOIN  tb_charge_log c ON c.charge_order_id=o.id
    WHERE o.shop_detail_id=#{shopDetailId}
    AND o.order_state = 1
    <if test="beginDate != null and beginDate != ''">
      AND  <![CDATA[  o.finish_time>=#{beginDate} ]]>
    </if>
    <if test="endDate != null and endDate != ''">
      AND  <![CDATA[ o.finish_time <= #{ endDate } ]]>
    </if>

</select>


  <update id="updateBalance">
  	update tb_charge_order
  	set charge_balance = charge_balance-#{useCharge},
  	reward_balance = reward_balance-#{useReward},
  	total_balance = charge_balance+reward_balance
  	where id = #{id}
  </update>
  <update id="refundCharge">
  	update tb_charge_order
  	set charge_balance = charge_balance+#{0},
  	total_balance = charge_balance+reward_balance
  	where id=#{1}
  </update>
  <update id="refundReward">
  	update tb_charge_order
  	set reward_balance = reward_balance+#{0},
  	total_balance = charge_balance+reward_balance
  	where id=#{1}
  </update>


    <select id="selectByDateAndShopId" resultType="com.resto.shop.web.model.ChargeOrder">
        SELECT
        id,
        order_state,
        charge_money,
        shop_detail_id,
        brand_id
        FROM
        tb_charge_order
        WHERE
        shop_detail_id = #{shopId} and
        <![CDATA[
        create_time>#{beginDate} and create_time<#{endDate}
        ]]>
        AND order_state = 1
    </select>

    <select id="selectByDateAndBrandId" resultType="com.resto.shop.web.model.ChargeOrder">
        SELECT
        id,
        order_state,
        charge_money,
        shop_detail_id,
        brand_id
        FROM
        tb_charge_order
        WHERE
        brand_id = #{brandId} and
        <![CDATA[
        create_time>#{beginDate} and create_time<#{endDate}
        ]]>
        AND order_state = 1
    </select>


</mapper>
